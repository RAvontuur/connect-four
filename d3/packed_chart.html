<!doctype html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.8/d3.min.js" type="text/JavaScript"></script>
    <style>
    </style>
  </head>
  <body>
    <div id="viz">
      <svg style="width:600px;height:600px;" ></svg>
    </div>
    <script>
      d3.json("moves.json", vizroot);

      function vizroot(moves_parent) {
          var circles = viz(moves_parent, 0, 0, 600, []);
          display(circles, 0, 0);
      }

      function circle_size(d) {
          return d.value != null ? d.value + 1 : 0.1
      }

      function symbolToColor(symbol) {
          if (symbol == null) {
              return "none";
          }

          var obj = {"X": "red", "O": "yellow", "_": "grey"};
          return obj[symbol];
      }

      function viz(moves_parent, x, y, h, all_circles) {

        if (moves_parent.moves == null) {
            return all_circles;
        }

        var nestedMoves = d3.nest()
          .key(d => d.player)
          .entries(moves_parent.moves);

        var packableMoves = {id: "All Moves", values: nestedMoves};
        var packChart = d3.pack();

        // packChart.padding(10);

        packChart.size([h,h]);

        var root = d3.hierarchy(packableMoves, d => d.values).sum(d => circle_size(d));

        var circles = packChart(root).descendants();
        circles.forEach(circle => {
            circle.x = circle.x + x;
            circle.y = circle.y + y;
        });

        all_circles =  all_circles.concat(circles);

        circles.forEach(circle => all_circles = viz(circle.data, circle.x-circle.r, circle.y-circle.r, 2*circle.r, all_circles))

        return all_circles;
      }

      function display(circles, x, y) {
        d3.select("svg")
          .append("g")
            .attr("transform", "translate(" + x + "," + y + ")")
          .selectAll("circle")
          .data(circles)
          .enter()
          .append("circle")
            .attr("r", d => d.r)
            .attr("cx", d => d.x)
            .attr("cy", d => d.y)
            .style("fill", d => symbolToColor(d.data.player))
            .style("stroke", "black");
      }
    </script>
  </body>
</html>
